<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A+ COMMAND CENTER | LIVE FEED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background-color: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; display: none; /* Hidden until verified */ }
        
        /* LAYOUT */
        .grid-layout { display: grid; grid-template-rows: auto 1fr; height: 100%; }
        .main-view { display: grid; grid-template-columns: 2fr 1fr; gap: 2px; height: 100%; background: #111; }
        
        /* PANELS */
        .panel { background: #000; border: 1px solid #1a1a1a; padding: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .panel-header { display: flex; justify-content: space-between; border-bottom: 1px solid #1a1a1a; padding-bottom: 10px; margin-bottom: 10px; }
        .panel-title { font-size: 0.8rem; letter-spacing: 2px; color: #666; font-weight: 800; }
        
        /* TERMINAL LOG */
        #terminal { flex-grow: 1; overflow-y: auto; font-size: 0.75rem; line-height: 1.6; scroll-behavior: smooth; }
        .log-entry { margin-bottom: 4px; border-left: 2px solid transparent; padding-left: 8px; animation: fadeIn 0.2s; }
        .log-time { color: #444; margin-right: 10px; }
        .log-type { font-weight: bold; margin-right: 10px; }
        
        .type-TRAFFIC { color: #00ff41; border-left-color: #00ff41; }
        .type-THREAT { color: #ff0000; border-left-color: #ff0000; background: rgba(255,0,0,0.05); }
        .type-SYSTEM { color: #0088ff; border-left-color: #0088ff; }
        .type-BLOCK { color: #ffff00; border-left-color: #ffff00; }

        /* METRICS */
        .stat-card { background: #0a0a0a; border: 1px solid #222; padding: 15px; margin-bottom: 10px; }
        .stat-val { font-size: 2rem; font-weight: bold; line-height: 1; }
        .stat-label { font-size: 0.6rem; color: #555; letter-spacing: 1px; text-transform: uppercase; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #00ff41; }
    </style>
</head>
<body class="grid-layout">

    <header class="bg-black border-b border-gray-900 p-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold tracking-widest text-white">A+ OVERWATCH</h1>
            <div class="flex items-center gap-2 px-3 py-1 bg-green-900/20 rounded border border-green-900">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-[10px] text-green-500 font-bold">LIVE FEED ACTIVE</span>
            </div>
        </div>
        <div class="flex gap-4">
            <div id="clock" class="text-gray-500 text-xs mt-1 font-bold">00:00:00</div>
            <button onclick="logout()" class="text-xs text-red-500 hover:text-red-400 border border-red-900/50 px-3 py-1 rounded hover:bg-red-900/20 transition">[ TERMINATE SESSION ]</button>
        </div>
    </header>

    <div class="main-view">
        
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">EVENT STREAM</span>
                <span class="text-[10px] text-gray-600">PORT 3000 LISTENER</span>
            </div>
            <div id="terminal">
                <div class="log-entry"><span class="log-time">--:--:--</span><span class="log-type type-SYSTEM">SYSTEM</span> Initializing Secure Uplink...</div>
            </div>
        </div>

        <div class="panel bg-black border-l border-gray-800">
            <div class="panel-header">
                <span class="panel-title">THREAT INTELLIGENCE</span>
            </div>
            
            <div class="stat-card border-l-4 border-l-green-500">
                <div class="stat-val text-green-500" id="cnt-humans">0</div>
                <div class="stat-label">Verified Humans</div>
            </div>

            <div class="stat-card border-l-4 border-l-red-600">
                <div class="stat-val text-red-600" id="cnt-threats">0</div>
                <div class="stat-label">Threats Neutralized</div>
            </div>

            <div class="stat-card border-l-4 border-l-blue-500">
                <div class="stat-val text-blue-500" id="cnt-integrity">V176</div>
                <div class="stat-label">Sentinel Version</div>
            </div>

            <div class="mt-auto">
                <div class="text-[10px] text-gray-500 mb-2">MODULE STATUS</div>
                <div class="space-y-2 border-t border-gray-800 pt-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">SENTINEL AI</span>
                        <span class="text-green-500 font-bold">ONLINE</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">ABYSS INTEGRITY</span>
                        <span class="text-green-500 font-bold">ARMED</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">NIGHTMARE AUTH</span>
                        <span class="text-green-500 font-bold">ACTIVE</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">GOD LOCK</span>
                        <span class="text-blue-500 font-bold">SECURE</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GOD LOCK PROTOCOL (Verify Token with Server) ---
        const sessionToken = sessionStorage.getItem('chaos_session');

        async function verifyAccess() {
            if (!sessionToken) {
                terminateSession("NO CREDENTIALS FOUND");
                return;
            }

            try {
                // Check token against server secret
                const res = await fetch('/api/admin/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: sessionToken })
                });
                
                const data = await res.json();
                
                if (!data.valid) {
                    terminateSession("INVALID SESSION TOKEN");
                } else {
                    // ACCESS GRANTED
                    document.body.style.display = "grid"; // Reveal UI
                    startClock();
                    connectLiveWire(); 
                    console.log(">>> [ADMIN] GOD LOCK OPEN.");
                }
            } catch (e) {
                terminateSession("SERVER HANDSHAKE FAILED");
            }
        }

        function terminateSession(reason) {
            console.warn(`>>> [SECURITY] LOCKOUT: ${reason}`);
            sessionStorage.removeItem('chaos_session');
            document.body.style.display = "flex";
            document.body.innerHTML = `
                <div class="flex items-center justify-center h-screen text-red-600 font-bold bg-black flex-col w-full">
                    <i class="fas fa-shield-alt text-6xl mb-6"></i>
                    <div class="text-2xl tracking-widest">ACCESS DENIED</div>
                    <div class="text-xs text-gray-600 mt-4 font-mono border border-red-900 p-2 rounded">ERROR: ${reason}</div>
                </div>
            `;
            setTimeout(() => window.location.href = '/app', 2000);
        }

        function logout() {
            sessionStorage.removeItem('chaos_session');
            window.location.href = '/';
        }

        function startClock() {
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            }, 1000);
        }

        // --- LIVE WIRE CONNECTION ---
        let humanCount = 0;
        let threatCount = 0;

        function connectLiveWire() {
            const evtSource = new EventSource("/api/live-wire");
            
            evtSource.onmessage = function(event) {
                try {
                    const payload = JSON.parse(event.data);
                    logEvent(payload);
                    updateMetrics(payload);
                } catch(e) { console.error("Data Parse Error", e); }
            };

            evtSource.onerror = function() {
                logEvent({ type: 'SYSTEM', data: 'Signal Lost. Re-acquiring...' });
                evtSource.close();
                setTimeout(connectLiveWire, 3000);
            };
        }

        function logEvent(payload) {
            const term = document.getElementById('terminal');
            const row = document.createElement('div');
            row.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString();
            let msg = typeof payload.data === 'string' ? payload.data : JSON.stringify(payload.data);
            
            // Format JSON data for readability
            if (typeof payload.data === 'object') {
                if (payload.data.reason) msg = `REASON: ${payload.data.reason} | SCORE: ${payload.data.score || 0}`;
                if (payload.data.status) msg = `STATUS: ${payload.data.status}`;
                if (payload.data.ip) msg += ` [IP: ${payload.data.ip}]`;
            }

            row.innerHTML = `<span class="log-time">${time}</span><span class="log-type type-${payload.type}">${payload.type}</span> ${msg}`;
            
            term.appendChild(row);
            term.scrollTop = term.scrollHeight; // Auto-scroll to newest
        }

        function updateMetrics(payload) {
            if (payload.type === 'TRAFFIC') {
                humanCount++;
                document.getElementById('cnt-humans').innerText = humanCount;
            }
            if (payload.type === 'THREAT' || payload.type === 'BLOCK') {
                threatCount++;
                document.getElementById('cnt-threats').innerText = threatCount;
                // Red Flash Effect
                document.body.style.boxShadow = "inset 0 0 50px rgba(255,0,0,0.3)";
                setTimeout(() => document.body.style.boxShadow = "none", 200);
            }
        }

        // STARTUP
        verifyAccess();
    </script>
</body>
</html>
