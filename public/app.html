<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A+ CHAOS | SECURE LOGIN GATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@simplewebauthn/browser@10.0.0/dist/bundle/index.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background-color: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .smart-btn { width: 100%; padding: 1.5rem; font-size: 1.2rem; font-weight: bold; border: 2px solid #00ff41; background: #111; color: #fff; border-radius: 12px; margin-top: 20px; }
        .hud-status { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 1rem; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-6 bg-black">

    <div id="hud" class="hud-status text-green-500">SYSTEM READY</div>
    <button id="main-btn" class="smart-btn" onclick="handleMainAction()">INITIALIZE IDENTITY</button>

    <script>
        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
        const API_BASE = '/api/v1';

        function updateHUD(text, color) { document.getElementById('hud').innerText = text; document.getElementById('hud').style.color = color; }

        async function handleMainAction() {
            const btn = document.getElementById('main-btn');
            btn.disabled = true;
            await doRegister(); // Default to Register for V55 Reset
            btn.disabled = false;
        }

        async function doRegister() {
            updateHUD("INITIALIZING...", "#ffff00");
            try {
                const resp = await fetch(`${API_BASE}/auth/register-options`);
                const opts = await resp.json();

                // DIAGNOSTIC CHECK
                if (opts.error) throw new Error(opts.error);
                if (!opts.challenge) {
                    alert("DEBUG: Server sent invalid options!\n" + JSON.stringify(opts));
                    throw new Error("Invalid Server Response");
                }

                updateHUD("SCAN NOW", "#ffffff");
                const attResp = await startRegistration(opts);

                updateHUD("SECURING...", "#0000ff");
                const verifyResp = await fetch(`${API_BASE}/auth/register-verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(attResp)
                });

                const result = await verifyResp.json();
                if (result.verified) {
                    // SHOW DNA
                    alert("SUCCESS! NEW DNA:\n\n" + result.adminDNA);
                    updateHUD("IDENTITY LOCKED", "#00ff00");
                } else {
                    throw new Error("Registration Failed");
                }
            } catch (e) {
                updateHUD("FAILED", "#ff0000");
                alert("ERROR: " + e.message);
            }
        }
    </script>
</body>
</html>


