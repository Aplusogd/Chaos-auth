// --- In public/app.html's <script> block, replace attemptLogin and its helpers ---

// The new API call to get all necessary data at once
async function getVerifiedData(key) {
    try {
        const res = await fetch('/api/v1/sentinel/verify', { headers: { 'x-api-key': key } });
        if (res.status === 200) {
            return await res.json();
        }
    } catch (e) { return null; }
    return null;
}

async function attemptLogin() {
    const input = document.getElementById('callsignInput').value.trim();
    const msg = document.getElementById('challenge-status');

    if (!input) {
        msg.innerText = "ENTER CALLSIGN OR MASTER KEY FIRST.";
        return;
    }
    
    // 1. Determine Key
    let key = input;
    if (!input.toLowerCase().startsWith('sk_')) {
        const cleanPhrase = input.toLowerCase().replace(/\s+/g, '-');
        key = "sk_ghost_" + CryptoJS.SHA256(cleanPhrase + "INFINITE_ABYSS_2025").toString().substring(0,32);
    }
    
    // Check trace unless it is the Master Key
    if (chaosMetric < 500 && !key.toLowerCase().includes('sk_chaos')) {
         msg.innerText = "PERFORM BIOMETRIC TRACE TO VERIFY.";
         return;
    }

    loginBtn.disabled = true;
    loginBtn.textContent = "VERIFYING IDENTITY...";

    // 2. Self-Heal and Get Verified Data
    await registerWithServer(key, input, chaosMetric); // Ensure key is on server (Self-Heal)
    
    // 3. CRITICAL: Fetch ALL necessary data before proceeding
    const verifiedData = await getVerifiedData(key);

    if (verifiedData) {
        localStorage.setItem('chaos_key_vault', key);
        // Store the bulky data in SESSION Storage (fast, temporary, only for this login)
        sessionStorage.setItem('verified_user_data', JSON.stringify(verifiedData));
        
        loginBtn.textContent = "ACCESS GRANTED";
        setTimeout(() => {
            window.location.href = '/check.html'; // Direct, fast redirect
        }, 500);
        
    } else {
        loginBtn.disabled = false;
        loginBtn.textContent = "VERIFY AND ACCESS";
        msg.innerText = "VERIFICATION FAILED. KEY UNKNOWN OR TRACE LOW.";
    }
}

// (Keep the registerWithServer function and all drawing/utility functions intact)
