<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A+ CHAOS | SECURE LOGIN GATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@simplewebauthn/browser@10.0.0/dist/bundle/index.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background-color: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .smart-btn { width: 100%; padding: 1.5rem; font-size: 1.2rem; font-weight: bold; border: 2px solid #00ff41; background: #111; color: #fff; border-radius: 12px; margin-top: 20px; }
        .danger-btn { width: 100%; padding: 1rem; font-size: 1rem; font-weight: bold; border: 1px solid #ff0000; background: #330000; color: #ff0000; border-radius: 12px; margin-top: 10px; }
        .hud-status { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 1rem; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-6 bg-black">

    <div id="hud" class="hud-status text-green-500">SYSTEM READY</div>
    
    <button id="main-btn" class="smart-btn" onclick="handleMainAction()">VERIFY IDENTITY</button>
    
    <!-- Hidden Reset Button -->
    <button id="reset-btn" class="danger-btn hidden" onclick="doRegister()">FORCE NEW REGISTRATION</button>

    <script>
        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
        const API_BASE = '/api/v1';
        const HEADERS = { 'Content-Type': 'application/json' };

        function updateHUD(text, color) { document.getElementById('hud').innerText = text; document.getElementById('hud').style.color = color; }

        async function handleMainAction() {
            // Try Login first. If 404/Error, show Reset button.
            await doLogin();
        }

        async function doLogin() {
            updateHUD("VERIFYING...", "#ffffff");
            try {
                const resp = await fetch(`${API_BASE}/auth/login-options`);
                if (resp.status === 404) {
                    throw new Error("RESET_REQUIRED");
                }
                const opts = await resp.json();
                const asseResp = await startAuthentication({ publicKey: opts });
                const verifyResp = await fetch(`${API_BASE}/auth/login-verify`, {
                    method: 'POST', headers: HEADERS, body: JSON.stringify(asseResp)
                });
                const result = await verifyResp.json();
                if (result.verified) {
                    sessionStorage.setItem('chaos_session', result.token);
                    window.location.href = '/dashboard.html';
                } else throw new Error("Invalid Credentials");
            } catch (e) {
                updateHUD("ACCESS DENIED", "#ff0000");
                // Show the Force Reset button so you can fix it
                document.getElementById('reset-btn').classList.remove('hidden');
                document.getElementById('reset-btn').innerText = "TAP TO RE-REGISTER DEVICE";
                console.error(e);
            }
        }

        async function doRegister() {
            updateHUD("INITIALIZING NEW KEY...", "#ffff00");
            try {
                const resp = await fetch(`${API_BASE}/auth/register-options`);
                const opts = await resp.json();
                
                // FORCE PLATFORM AUTHENTICATOR
                const attResp = await startRegistration(opts);

                updateHUD("SAVING...", "#0000ff");
                const verifyResp = await fetch(`${API_BASE}/auth/register-verify`, {
                    method: 'POST', headers: HEADERS, body: JSON.stringify(attResp)
                });

                const result = await verifyResp.json();
                if (result.verified) {
                    const dna = result.adminDNA;
                    // COPY DNA LOGIC
                    const copyArea = document.createElement('textarea');
                    copyArea.value = dna;
                    document.body.appendChild(copyArea);
                    copyArea.select();
                    try { document.execCommand('copy'); alert("NEW DNA COPIED! SAVE THIS."); } catch(e) { alert("COPY FAILED. SEE SCREEN."); }
                    
                    updateHUD("SUCCESS. LOGGING IN...", "#00ff00");
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (e) {
                updateHUD("REGISTRATION FAILED", "#ff0000");
                alert(e.message);
            }
        }
    </script>
</body>
</html>


