<script>
        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
        const HEADERS = { 'Content-Type': 'application/json', 'X-APLUS-SECURE': 'TOTEM_V8_BIO' };

        // UTILS (HUD, Toast, Buzz) ...
        function updateHUD(text, color = 'text-green-500') {
            const h = document.getElementById('hud');
            h.innerText = text;
            h.className = `hud-status ${color}`;
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        function buzz() { if (navigator.vibrate) navigator.vibrate([50]); }

        // --- 1. REGISTER ---
        async function doRegister() {
            updateHUD("CONNECTING...", "text-yellow-400");
            try {
                const resp = await fetch('/api/v1/auth/register-options', { headers: HEADERS });
                if (!resp.ok) throw new Error("System Locked. Admin already registered."); // Changed error message
                const opts = await resp.json();

                updateHUD("SCAN FINGERPRINT", "text-white animate-pulse");
                buzz();
                const attResp = await startRegistration(opts);

                updateHUD("VERIFYING...", "text-blue-400");
                const verifyResp = await fetch('/api/v1/auth/register-verify', {
                    method: 'POST',
                    headers: HEADERS,
                    body: JSON.stringify(attResp)
                });

                const result = await verifyResp.json();

                if (result.verified) {
                    updateHUD("ACCESS SECURED", "text-green-500");
                    // Show DNA for mobile copy if feature is enabled
                    if (result.adminDNA) {
                        const copyArea = document.createElement('textarea');
                        copyArea.value = result.adminDNA;
                        document.body.appendChild(copyArea);
                        copyArea.select();
                        try {
                            document.execCommand('copy');
                            alert("ADMIN DNA COPIED! Paste into Render Environment Variables.");
                        } catch (err) {
                            alert("COPY FAILED. Manually copy the text at the top of the screen.");
                        }
                        setTimeout(() => document.body.removeChild(copyArea), 15000);
                    } else {
                        showToast("SUCCESS: Device Bound");
                    }
                } else { throw new Error("Verification Rejected"); }
            } catch (e) { updateHUD("FAILED", "text-red-500"); showToast(e.message); }
        }

        // --- 2. LOGIN ---
        async function doLogin() {
            updateHUD("CONNECTING...", "text-blue-400");
            try {
                const resp = await fetch('/api/v1/auth/login-options', { headers: HEADERS });
                if(!resp.ok) throw new Error("System Empty. Please Register First.");
                const opts = await resp.json();

                updateHUD("SCAN FINGERPRINT", "text-white animate-pulse");
                buzz();
                const asseResp = await startAuthentication(opts);

                updateHUD("CHECKING...", "text-blue-400");
                const verifyResp = await fetch('/api/v1/auth/login-verify', {
                    method: 'POST',
                    headers: HEADERS,
                    body: JSON.stringify(asseResp)
                });

                const result = await verifyResp.json();

                if (result.verified) {
                    updateHUD("UNLOCKED", "text-green-500");
                    document.body.style.backgroundColor = "#002200"; 
                    buzz();
                    
                    if(result.token) {
                        sessionStorage.setItem('chaos_session', result.token);
                    }

                    showToast("Redirecting to Command Center...");
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1500);

                } else { 
                    // Handle DREAMS Rejection specifically
                    if (result.error && result.error.includes("TEMPORAL_ANOMALY")) {
                        throw new Error("ACCESS DENIED: Behavioral Anomaly Detected.");
                    } else {
                        throw new Error("Invalid Credentials.");
                    }
                }
            } catch (e) {
                updateHUD("DENIED", "text-red-500");
                document.body.style.backgroundColor = "#220000";
                showToast(e.message);
                buzz();
                setTimeout(() => document.body.style.backgroundColor = "#000", 2000);
            }
        }
    </script>
</body>
</html>
