<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAOS | Bio-Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SimpleWebAuthn Browser Library -->
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #050505; color: #e5e5e5; font-family: 'JetBrains Mono', monospace; overflow-x: hidden; user-select: none; }
        .abyss-bg { background-image: linear-gradient(rgba(0, 255, 128, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 128, 0.03) 1px, transparent 1px); background-size: 30px 30px; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; }
        .console-box { background: rgba(10, 10, 10, 0.9); border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">
    <div class="abyss-bg"></div>

    <header class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
        <div><h1 class="text-2xl md:text-3xl font-bold tracking-widest text-white"><i class="fas fa-dna mr-2 text-green-500"></i>CHAOS <span class="text-xs align-top text-gray-500">V.8</span></h1><p class="text-xs text-gray-500 mt-1">BIO-LINK PROTOCOL</p></div>
        <div class="text-right"><div id="bio-status" class="text-[10px] text-gray-600">SENSOR READY</div></div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow relative">
        <div class="lg:col-span-8 flex flex-col gap-6">
            <div class="console-box rounded-lg p-4 h-64 md:h-96 overflow-y-auto font-mono text-xs flex flex-col-reverse" id="console"><div class="text-gray-600">> System Ready.</div></div>
        </div>

        <div class="lg:col-span-4 flex flex-col gap-6">
            <div class="console-box rounded-lg p-6 relative overflow-hidden">
                <h2 class="text-xl font-bold mb-2 text-blue-500">IDENTITY UPLINK</h2>
                <div id="auth-state" class="text-xs text-gray-400 mb-6">AWAITING BIOMETRICS</div>
                
                <div id="register-panel" class="hidden space-y-3">
                    <p class="text-xs text-yellow-500">⚠️ SYSTEM UNCLAIMED</p>
                    <button id="btn-register" class="w-full py-4 bg-yellow-900/30 border border-yellow-500/50 hover:bg-yellow-900/50 text-yellow-400 font-bold rounded transition"><i class="fas fa-fingerprint"></i> CLAIM SYSTEM (Register)</button>
                </div>

                <div id="login-panel" class="hidden space-y-3">
                    <button id="btn-login" class="w-full py-4 bg-green-900/30 border border-green-500/50 hover:bg-green-900/50 text-green-400 font-bold rounded transition"><i class="fas fa-unlock"></i> VERIFY IDENTITY</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const log = (msg, type='info') => {
            const consoleEl = document.getElementById('console');
            const div = document.createElement('div');
            div.className = 'mb-1 ' + (type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-500' : 'text-gray-400');
            div.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            consoleEl.insertBefore(div, consoleEl.firstChild);
        };

        const HEADERS = { 'Content-Type': 'application/json', 'X-APLUS-SECURE': 'TOTEM_V8_BIO' };

        // --- 1. INITIALIZE: AM I REGISTERED? ---
        async function checkStatus() {
            try {
                const res = await fetch('/api/v1/auth/status', { headers: HEADERS });
                const data = await res.json();
                
                if (data.registered) {
                    document.getElementById('login-panel').classList.remove('hidden');
                    log("System Bound. Login Required.", "info");
                } else {
                    document.getElementById('register-panel').classList.remove('hidden');
                    log("New System. Registration Required.", "warning");
                }
            } catch(e) { log("Server Offline.", "error"); }
        }

        // --- 2. REGISTER (BIND FACE/FINGER) ---
        document.getElementById('btn-register').addEventListener('click', async () => {
            log("Initiating Biometric Bind...", "info");
            try {
                // Get Options
                const resp = await fetch('/api/v1/auth/register-options', { headers: HEADERS });
                if (!resp.ok) throw new Error("Failed to get options");
                const options = await resp.json();

                // Use Library to handle encoding automatically
                log("Touch Sensor now...", "info");
                const attResp = await SimpleWebAuthnBrowser.startRegistration(options);

                // Send Result
                const verifyResp = await fetch('/api/v1/auth/register-verify', {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify(attResp)
                });
                const verifyData = await verifyResp.json();

                if (verifyData.verified) {
                    log("✅ BIOMETRICS BOUND. You are now the Admin.", "success");
                    setTimeout(() => location.reload(), 2000);
                } else {
                    log("❌ Binding Failed.", "error");
                }
            } catch(e) { 
                console.error(e);
                log("Error: " + e.message, "error"); 
            }
        });

        // --- 3. LOGIN (VERIFY HUMAN) ---
        document.getElementById('btn-login').addEventListener('click', async () => {
            log("Requesting Bio-Link...", "info");
            try {
                // Get Options
                const resp = await fetch('/api/v1/auth/login-options', { headers: HEADERS });
                if (!resp.ok) throw new Error("Failed to get login options");
                const options = await resp.json();

                // Use Library
                log("Scanning...", "info");
                const authResp = await SimpleWebAuthnBrowser.startAuthentication(options);

                // Verify
                const verifyResp = await fetch('/api/v1/auth/login-verify', {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify(authResp)
                });
                const verifyData = await verifyResp.json();

                if (verifyData.verified) {
                    log("✅ IDENTITY CONFIRMED. Session: " + verifyData.session.substring(0,8), "success");
                    document.getElementById('auth-state').innerText = "SECURE";
                    document.getElementById('auth-state').className = "text-xs text-green-500 mb-6 font-bold";
                } else {
                    log("❌ Access Denied.", "error");
                }
            } catch(e) { 
                console.error(e);
                log("Error: " + e.message, "error"); 
            }
        });

        checkStatus();
    </script>
</body>
</html>


