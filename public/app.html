<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A+ CHAOS | SECURE LOGIN GATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@simplewebauthn/browser@10.0.0/dist/bundle/index.umd.min.js"></script>
    <style>
        /* ... (Keep existing styles) ... */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background-color: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .smart-btn { width: 100%; padding: 1.8rem; font-size: 1.3rem; font-weight: bold; border: 2px solid #00ff41; background: #001a00; color: #00ff41; border-radius: 16px; }
        .smart-btn:disabled { opacity: 0.4; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-6 bg-black">

    <h1 class="text-3xl font-bold mb-10 text-white">BIOMETRIC GATE</h1>
    
    <!-- DREAMS V4 COGNITIVE TRAP (Invisible) -->
    <div id="cognitive-pixel" style="width:1px;height:1px;opacity:0.01;position:absolute;"></div>

    <button id="main-btn" class="smart-btn" onclick="handleMainAction()">
        INITIALIZING...
    </button>

    <div id="toast" class="fixed bottom-6 bg-gray-900 text-white px-6 py-3 rounded opacity-0 transition"></div>

    <script>
        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
        const API_BASE = '/api/v1';
        const HEADERS = { 'Content-Type': 'application/json' };

        let isRegistered = false;
        
        // --- DREAMS V4: COGNITIVE METRICS ---
        let mousePath = [];
        let interactionStart = Date.now();

        document.addEventListener('mousemove', (e) => {
            mousePath.push({x: e.clientX, y: e.clientY, t: Date.now()});
            if(mousePath.length > 20) mousePath.shift();
        });
        
        document.addEventListener('touchstart', () => {
            mousePath.push({t: Date.now(), type: 'touch'});
        });

        function getCognitiveData() {
            // Calculate entropy (simplified for demo)
            let entropy = mousePath.length > 5 ? 0.8 : 0.1; 
            let reactionTime = Date.now() - interactionStart;
            return { entropy, reactionTime };
        }

        // --- MAIN LOGIC ---
        async function checkEnvironment() {
            const btn = document.getElementById('main-btn');
            try {
                const statusResp = await fetch(`${API_BASE}/auth/login-options`, { headers: HEADERS });
                // If we get options, user exists (or slot is open)
                isRegistered = true; 
                btn.innerText = 'CLAIM / VERIFY';
                btn.disabled = false;
            } catch (e) {
                btn.innerText = "OFFLINE";
            }
        }

        async function handleMainAction() {
            const btn = document.getElementById('main-btn');
            btn.disabled = true;

            // Try Login First. If it fails "No Credentials", we Register.
            try {
                await doLogin();
            } catch (e) {
                console.log("Login failed, attempting Registration...");
                await doRegister();
            }
            btn.disabled = false;
        }

        async function doRegister() {
            try {
                const opts = await (await fetch(`${API_BASE}/auth/register-options`, { headers: HEADERS })).json();
                const regResp = await startRegistration(opts);
                const verifyResp = await fetch(`${API_BASE}/auth/register-verify`, {
                    method: 'POST', headers: HEADERS, body: JSON.stringify(regResp)
                });
                const res = await verifyResp.json();
                if (res.verified) {
                    alert(`NEW DNA GENERATED:\n\n${res.adminDNA}\n\nCOPY THIS TO SERVER.`);
                    location.reload();
                }
            } catch(e) { alert("Setup Failed: " + e.message); }
        }

        async function doLogin() {
            const opts = await (await fetch(`${API_BASE}/auth/login-options`, { headers: HEADERS })).json();
            const asseResp = await startAuthentication({ publicKey: opts });
            
            // INJECT DREAMS V4 DATA
            const payload = {
                ...asseResp,
                cognitive_data: getCognitiveData()
            };

            const verifyResp = await fetch(`${API_BASE}/auth/login-verify`, {
                method: 'POST', headers: HEADERS, body: JSON.stringify(payload)
            });
            const result = await verifyResp.json();

            if (result.verified) {
                sessionStorage.setItem('chaos_session', result.token);
                window.location.href = '/dashboard.html';
            } else {
                throw new Error(result.error);
            }
        }

        window.onload = checkEnvironment;
    </script>
</body>
</html>


