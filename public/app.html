<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A+ CHAOS | IMMORTAL GATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@simplewebauthn/browser@10.0.0/dist/bundle/index.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { background-color: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; touch-action: none; overflow: hidden; }
        .hud-status { font-size: 1.5rem; font-weight: 800; text-align: center; margin-top: 10vh; text-shadow: 0 0 10px #00ff41; }
        .totem { width: 90px; height: 90px; background: #00ff41; border-radius: 50%; position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; justify-content: center; font-size: 36px; color: #002200; box-shadow: 0 0 25px #00ff41; }
    </style>
</head>
<body class="h-screen w-screen">

    <div id="hud" class="hud-status text-yellow-500">CONNECTING...</div>
    <div class="totem" id="totem"><i class="fas fa-fingerprint"></i></div>

    <script>
        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
        const API_BASE = '/api/v1';
        const HEADERS = { 'Content-Type': 'application/json' };
        
        let mode = 'LOGIN';

        async function preheat() {
            try {
                const resp = await fetch(`${API_BASE}/auth/login-options`, { headers: HEADERS });
                if(resp.ok) {
                    mode = 'LOGIN';
                    document.getElementById('hud').innerText = "CAST TOTEM";
                    document.getElementById('hud').className = "hud-status text-green-500";
                } else if (resp.status === 404) {
                    mode = 'REGISTER';
                    document.getElementById('hud').innerText = "IMPRINT IDENTITY";
                    document.getElementById('hud').className = "hud-status text-blue-400";
                    document.getElementById('totem').style.background = "#0088ff";
                }
            } catch(e) { setTimeout(preheat, 2000); }
        }
        setTimeout(preheat, 100);

        document.getElementById('totem').addEventListener('click', async () => {
            if (mode === 'REGISTER') await doRegister();
            else await doLogin();
        });

        async function doRegister() {
            document.getElementById('hud').innerText = "SCANNING...";
            try {
                const opts = await (await fetch(`${API_BASE}/auth/register-options`)).json();
                const attResp = await startRegistration(opts);
                const verifyResp = await fetch(`${API_BASE}/auth/register-verify`, {
                    method: 'POST', headers: HEADERS, body: JSON.stringify(attResp)
                });
                const res = await verifyResp.json();
                
                if (res.verified) {
                    // SHOW THE VAULT KEYS
                    const msg = `
SAVE THESE IN RENDER ENVIRONMENT VARIABLES:

Key: ADMIN_CRED_ID
Value: ${res.env_ID}

Key: ADMIN_PUB_KEY
Value: ${res.env_KEY}
                    `;
                    const ta = document.createElement('textarea');
                    ta.value = msg;
                    ta.style.position='fixed'; ta.style.top='0'; ta.style.left='0'; ta.style.width='100%'; ta.style.height='50%';
                    document.body.appendChild(ta);
                    alert("IDENTITY SAVED. COPY THE KEYS ON SCREEN.");
                }
            } catch(e) { alert(e.message); }
        }

        async function doLogin() {
            document.getElementById('hud').innerText = "VERIFYING...";
            try {
                const opts = await (await fetch(`${API_BASE}/auth/login-options`)).json();
                const asseResp = await startAuthentication({ publicKey: opts });
                const verifyResp = await fetch(`${API_BASE}/auth/login-verify`, {
                    method: 'POST', headers: HEADERS, body: JSON.stringify(asseResp)
                });
                const res = await verifyResp.json();
                if(res.verified) {
                    document.getElementById('hud').innerText = "CONFIRMED";
                    setTimeout(() => location.href = '/dashboard.html', 1000);
                } else throw new Error(res.error);
            } catch(e) {
                document.getElementById('hud').innerText = "DENIED";
                alert("Login Failed: " + e.message);
            }
        }
    </script>
</body>
</html>


