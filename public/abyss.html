<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENTER THE ABYSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        .portal-card {
            background: rgba(5,5,5,0.9); border: 1px solid #222; padding: 30px; 
            max-width: 400px; width: 90%; box-shadow: 0 0 80px rgba(0, 255, 65, 0.05);
            backdrop-filter: blur(5px);
        }

        #chaosCanvas {
            border: 1px solid #005500; background: #000; margin-bottom: 20px;
            cursor: crosshair;
            box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.1);
            touch-action: none; /* Critical for mobile dragging */
            border-radius: 50%; /* Visual hint */
        }

        .input-line {
            background: #111; border: 1px solid #333; color: white; padding: 12px; text-align: center;
            border-radius: 4px; font-size: 1rem;
        }
    </style>
</head>
<body>

    <div id="loading" class="absolute inset-0 bg-black z-50 flex items-center justify-center hidden">
        <i class="fas fa-circle-notch fa-spin text-4xl text-green-500 mb-4"></i>
    </div>

    <div class="portal-card text-center">
        <i class="fas fa-fingerprint text-3xl text-green-600 mb-2"></i>
        <h1 class="text-xl font-bold tracking-widest mb-1 text-white">BIOMETRIC TRACE</h1>
        <p class="text-gray-500 text-xs mb-6">Draw a circle to verify humanity.</p>

        <div id="challenge-area" class="flex flex-col items-center">
            <canvas id="chaosCanvas" width="280" height="280"></canvas>
            <p class="text-[10px] text-gray-500 mb-4 font-bold uppercase tracking-widest" id="challenge-status">TRACE THE GREEN CIRCLE</p>
        </div>

        <input type="text" id="aliasInput" class="input-line w-full mb-4" placeholder="Enter Codename">
        
        <button onclick="attemptManifest()" id="manifest-btn" class="bg-green-800 text-green-400 border border-green-600 px-8 py-3 rounded font-bold text-sm transition duration-300 w-full disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-600 hover:text-black">
            INITIATE
        </button>

        <div class="mt-6 pt-4 border-t border-gray-800 flex justify-between">
            <a href="/" class="text-gray-600 hover:text-white text-xs">‚Üê Back</a>
            <a href="/login" class="text-gray-600 hover:text-white text-xs">Admin Login</a>
        </div>
    </div>

    <script>
        const challengeStatus = document.getElementById('challenge-status');
        const canvas = document.getElementById('chaosCanvas');
        const ctx = canvas.getContext('2d');
        const manifestBtn = document.getElementById('manifest-btn');

        let isTracing = false;
        let chaosMetric = 0; 
        
        // Settings for the Circle
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 80;

        function drawTarget() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Guide Circle (Dim Green)
            ctx.strokeStyle = 'rgba(0, 255, 65, 0.15)';
            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.stroke();

            // Draw "Start Here" Dot
            ctx.fillStyle = 'rgba(0, 255, 65, 0.5)';
            ctx.beginPath();
            ctx.arc(centerX + radius, centerY, 5, 0, 2 * Math.PI);
            ctx.fill();
        }
        drawTarget();

        function startTrace(e) {
            isTracing = true;
            chaosMetric = 0;
            drawTarget(); // Clean slate
            e.preventDefault();
        }

        function moveTrace(e) {
            if (!isTracing) return;
            e.preventDefault();
            
            // Get coordinates
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            // Draw User Trace (Bright Green)
            ctx.fillStyle = '#00ff41';
            ctx.beginPath();
            ctx.arc(x, y, 2, 0, 2 * Math.PI); // Draw dots for smoother performance
            ctx.fill();

            // Calculate Distance from Center (Are they roughly tracing the circle?)
            const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            
            // Logic: If they are tracing NEAR the circle (radius +/- 40px), count it as valid entropy
            if (Math.abs(dist - radius) < 40) {
                chaosMetric += 5; // Accumulate score faster
            }
        }

        function endTrace() {
            if (!isTracing) return;
            isTracing = false;
            
            // Threshold: 300 is roughly one full quick circle
            if (chaosMetric > 300) { 
                challengeStatus.innerText = `BIOMETRIC VERIFIED (SCORE: ${chaosMetric})`;
                challengeStatus.style.color = "#00ff41";
                manifestBtn.disabled = false;
                manifestBtn.classList.remove('bg-green-800', 'text-green-400');
                manifestBtn.classList.add('bg-green-500', 'text-black');
            } else {
                challengeStatus.innerText = "TRACE INCOMPLETE. TRY AGAIN.";
                challengeStatus.style.color = "#ef4444";
                manifestBtn.disabled = true;
                setTimeout(drawTarget, 1000); // Reset visual
            }
        }

        canvas.addEventListener('mousedown', startTrace);
        canvas.addEventListener('mousemove', moveTrace);
        canvas.addEventListener('mouseup', endTrace);
        canvas.addEventListener('mouseleave', endTrace); // Stop if they leave canvas
        
        canvas.addEventListener('touchstart', startTrace);
        canvas.addEventListener('touchmove', moveTrace);
        canvas.addEventListener('touchend', endTrace);
        
        manifestBtn.disabled = true;

        // --- MANIFEST LOGIC ---
        async function attemptManifest() {
            const alias = document.getElementById('aliasInput').value.trim() || "Ghost_User";
            
            // Generate Random Words
            const DIMS = ["Crimson","Void","Obsidian","Plasma","Neon","Thunder","Abyss","Vortex","Ragnarok","Storm","Velvet","Razor","Leather","Mercury","Shatter"];
            const w1 = DIMS[Math.floor(Math.random() * DIMS.length)];
            const w2 = DIMS[Math.floor(Math.random() * DIMS.length)];
            const w3 = DIMS[Math.floor(Math.random() * DIMS.length)];
            const phrase = `${w1}-${w2}-${w3}`;
            const key = "sk_ghost_" + CryptoJS.SHA256(phrase + "INFINITE_ABYSS_2025").toString().substring(0, 32);

            document.getElementById('loading').classList.remove('hidden');

            try {
                // Register
                const res = await fetch('/api/auth/ghost-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ alias, chaos_metric: chaosMetric, provided_key: key })
                });
                const data = await res.json();
                
                if (data.success) {
                    localStorage.setItem('chaos_key_vault', key);
                    window.location.href = '/check.html';
                }
            } catch(e) {
                alert("Server Connection Failed");
                document.getElementById('loading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
