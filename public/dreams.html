<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>A+ DREAMS V5 | ACOUSTIC DIAGNOSTIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #000; color: #00ff41; font-family: monospace; overflow: hidden; }
        .visualizer { display: flex; align-items: flex-end; justify-content: center; height: 150px; gap: 2px; }
        .bar { width: 6px; background: #003300; transition: height 0.05s, background 0.2s; }
        .scan-line { position: absolute; top: 0; width: 100%; height: 2px; background: rgba(0, 255, 65, 0.2); animation: scan 3s linear infinite; }
        @keyframes scan { 0% {top:0;} 100% {top:100%;} }
        
        .status-box { border: 1px solid #333; padding: 20px; text-align: center; border-radius: 8px; background: #111; margin-top: 20px; }
        .status-box.optimal { border-color: #00ff41; box-shadow: 0 0 15px rgba(0,255,65,0.1); }
        .status-box.warning { border-color: #ff0000; box-shadow: 0 0 15px rgba(255,0,0,0.2); color: #ff5555; }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen p-4">
    <div class="scan-line"></div>

    <div class="max-w-md w-full">
        <div class="flex justify-between items-end border-b border-gray-800 pb-2 mb-6">
            <h1 class="text-2xl font-bold tracking-widest text-white">DREAMS V5</h1>
            <div class="text-xs text-green-600">ACOUSTIC FINGERPRINTING</div>
        </div>

        <div class="bg-black border border-gray-800 rounded p-4 mb-6 relative">
            <div class="absolute top-2 right-2 text-[10px] text-gray-500">HZ FREQUENCY</div>
            <div id="visualizer" class="visualizer">
                </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="simulateSound('HEALTHY')" class="bg-green-900 hover:bg-green-700 text-white p-4 rounded font-bold transition border border-green-800">
                <i class="fas fa-check-circle mr-2"></i> PLAY HEALTHY
            </button>
            <button onclick="simulateSound('BROKEN')" class="bg-red-900 hover:bg-red-700 text-white p-4 rounded font-bold transition border border-red-800">
                <i class="fas fa-exclamation-triangle mr-2"></i> PLAY BROKEN
            </button>
        </div>

        <div id="output" class="status-box hidden">
            <div class="text-xs uppercase tracking-widest mb-2" id="status-title">ANALYZING...</div>
            <div class="text-3xl font-bold" id="status-result">--</div>
            <div class="text-xs mt-2 text-gray-400" id="status-detail">Variance: 0</div>
        </div>
    </div>

    <script>
        // Setup Visualizer Bars
        const vis = document.getElementById('visualizer');
        const bars = [];
        for(let i=0; i<40; i++) {
            const b = document.createElement('div');
            b.className = 'bar';
            b.style.height = '10px';
            vis.appendChild(b);
            bars.push(b);
        }

        function simulateSound(type) {
            // Reset UI
            const out = document.getElementById('output');
            out.className = 'status-box';
            out.classList.remove('hidden');
            document.getElementById('status-result').innerText = "LISTENING...";
            document.getElementById('status-title').innerText = "SAMPLING AUDIO";
            document.getElementById('status-detail').innerText = "Processing FFT...";

            let frame = 0;
            const maxFrames = 50;
            
            // Animation Loop
            const interval = setInterval(() => {
                frame++;
                
                // GENERATE DATA
                let variance = 0;
                bars.forEach((b, i) => {
                    let h;
                    if(type === 'HEALTHY') {
                        // Smooth sine wave
                        h = 20 + Math.sin(frame * 0.2 + i * 0.5) * 15 + Math.random() * 5;
                        b.style.background = '#00ff41';
                        variance = 120; // Low variance
                    } else {
                        // Chaotic spikes
                        h = Math.random() * 80 + 10;
                        b.style.background = '#ff0000';
                        variance = 850; // High variance
                    }
                    b.style.height = h + 'px';
                });

                if(frame >= maxFrames) {
                    clearInterval(interval);
                    sendToBrain(type === 'HEALTHY' ? 120 : 850);
                }
            }, 30);
        }

        async function sendToBrain(simulatedVariance) {
            // CALL THE V149 SERVER
            try {
                const res = await fetch('/api/v1/hardware/diagnostic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        deviceId: 'SIMULATOR_01', 
                        variance: simulatedVariance, // V149 checks if this > 500
                        peakFreq: 240 
                    })
                });
                
                const data = await res.json();
                
                // UPDATE UI
                const out = document.getElementById('output');
                const title = document.getElementById('status-title');
                const result = document.getElementById('status-result');
                const detail = document.getElementById('status-detail');

                if(data.status === 'OPTIMAL') {
                    out.classList.add('optimal');
                    title.innerText = "SYSTEM HEALTH";
                    title.className = "text-xs uppercase tracking-widest mb-2 text-green-500";
                    result.innerText = "OPTIMAL";
                    result.className = "text-3xl font-bold text-green-400";
                } else {
                    out.classList.add('warning');
                    title.innerText = "THREAT DETECTED";
                    title.className = "text-xs uppercase tracking-widest mb-2 text-red-500";
                    result.innerText = "SPRING FATIGUE";
                    result.className = "text-3xl font-bold text-red-500";
                }
                detail.innerText = `Acoustic Variance: ${simulatedVariance.toFixed(1)}`;

            } catch(e) {
                alert("Server Connection Failed");
            }
        }
    </script>
</body>
</html>
