<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deep Forge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background: #000; color: #00ff41; font-family: monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        canvas { border: 2px solid #005500; background: #080808; border-radius: 50%; cursor: crosshair; }
        .progress-bar { height: 4px; background: #111; width: 300px; margin-top: 20px; }
        .fill { height: 100%; background: #00ff41; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="text-center">
        <h1 class="text-3xl font-bold mb-2">CALIBRATION</h1>
        <p class="text-xs text-gray-500 mb-6">Draw your sigil 5 times to forge ZK Proof.</p>

        <canvas id="canvas" width="300" height="300"></canvas>
        
        <div class="progress-bar mx-auto">
            <div id="fill" class="fill"></div>
        </div>
        <p id="status" class="mt-4 text-sm">Trace 1 / 5</p>
    </div>

    <script>
        let traces = 0;
        const required = 5;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function start(e) { 
            e.preventDefault(); 
            isDrawing = true; 
            ctx.clearRect(0,0,300,300); 
            ctx.beginPath();
        }

        function move(e) {
            if(!isDrawing) return;
            e.preventDefault();
            const t = e.touches ? e.touches[0] : e;
            const r = canvas.getBoundingClientRect();
            ctx.lineTo(t.clientX - r.left, t.clientY - r.top);
            ctx.strokeStyle = '#00ff41'; ctx.lineWidth = 3; ctx.stroke();
        }

        function end() {
            if(!isDrawing) return;
            isDrawing = false;
            traces++;
            
            // UI Update
            const pct = (traces / required) * 100;
            document.getElementById('fill').style.width = `${pct}%`;
            document.getElementById('status').innerText = `Trace ${traces} / ${required}`;

            if(traces >= required) {
                finishCalibration();
            } else {
                setTimeout(() => {
                    ctx.clearRect(0,0,300,300);
                    ctx.beginPath();
                }, 500);
            }
        }

        function finishCalibration() {
            // Generate ZK Commitment (Hash of the training)
            const seed = localStorage.getItem('callsign_history') || "UNKNOWN";
            const commitment = CryptoJS.SHA256(seed + Date.now() + "ZK_PROOF").toString();
            
            localStorage.setItem('zk_profile_commit', commitment);
            
            document.body.innerHTML = `
                <div class="text-center">
                    <h1 class="text-4xl text-white mb-4">FORGED.</h1>
                    <p class="text-green-500 mb-8">Zero-Knowledge Proof stored.</p>
                    <a href="/dashboard" class="border border-green-500 px-6 py-2 hover:bg-green-500 hover:text-black">ENTER SANCTUARY</a>
                </div>
            `;
        }

        ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e, start));
        ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e, move));
        ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e, end));
    </script>
</body>
</html>
