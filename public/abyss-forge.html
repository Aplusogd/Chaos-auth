<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABYSS FORGE V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; user-select: none; touch-action: none; }
        
        .void-bg {
            position: absolute; inset: 0; z-index: -1;
            background: radial-gradient(circle at center, #0a1a0a 0%, #000 100%);
        }

        #drawLayer {
            position: absolute; inset: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 10;
        }

        .hud-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 5;
            transition: opacity 0.5s;
        }

        .particle {
            position: absolute; background: #00ff41; border-radius: 50%;
            pointer-events: none; opacity: 0;
            animation: fadeParticle 1s forwards;
        }

        @keyframes fadeParticle {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }
    </style>
</head>
<body>

    <div class="void-bg"></div>
    <canvas id="drawLayer"></canvas>

    <div id="ui-setup" class="hud-center">
        <i class="fas fa-fingerprint text-5xl text-gray-800 mb-6 animate-pulse"></i>
        <h1 class="text-2xl text-white mb-2 font-bold tracking-widest">ABYSS FORGE</h1>
        <p class="text-xs text-gray-500 mb-6">Draw a secret sign. This becomes your key.</p>
        
        <div class="pointer-events-auto">
            <input id="callsign" type="text" placeholder="ENTER CALLSIGN" class="bg-black border border-gray-800 text-center text-green-500 p-2 text-sm rounded mb-4 uppercase w-64 focus:border-green-500 outline-none">
            <br>
            <button onclick="startSetup()" class="bg-green-900/30 text-green-400 border border-green-700 px-6 py-2 rounded text-xs font-bold hover:bg-green-500 hover:text-black transition">
                BEGIN RITUAL
            </button>
        </div>
    </div>

    <div id="ui-login" class="hud-center hidden">
        <i class="fas fa-infinity text-6xl text-gray-900 mb-4 transition-colors duration-300" id="lock-icon"></i>
        <div class="text-xs text-gray-600 tracking-[0.3em] font-bold" id="status-text">DRAW SIGIL</div>
    </div>

    <script>
        const canvas = document.getElementById('drawLayer');
        const ctx = canvas.getContext('2d');
        
        let rawPath = [];
        let isDrawing = false;
        let mode = 'INIT'; // INIT, RECORD, VERIFY

        // RESIZE
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 1. CORE LOGIC ---

        function startSetup() {
            const callsign = document.getElementById('callsign').value.trim();
            if(callsign.length < 3) return alert("Callsign Required");
            
            sessionStorage.setItem('temp_callsign', callsign);
            
            document.getElementById('ui-setup').classList.add('hidden');
            document.getElementById('ui-login').classList.remove('hidden');
            document.getElementById('status-text').innerText = "DRAW NEW SIGIL";
            document.getElementById('status-text').style.color = "#00ff41";
            mode = 'RECORD';
        }

        function startDraw(e) {
            if(mode === 'INIT') return;
            isDrawing = true;
            rawPath = [];
            ctx.clearRect(0,0,canvas.width, canvas.height);
            
            // Haptic
            if(navigator.vibrate) navigator.vibrate(10);
            
            const pt = getPoint(e);
            rawPath.push(pt);
            
            document.getElementById('ui-login').style.opacity = '0.2'; // Dim HUD while drawing
        }

        function moveDraw(e) {
            if(!isDrawing) return;
            const pt = getPoint(e);
            rawPath.push(pt);
            
            // Visuals
            renderTrail(pt);
            spawnParticle(pt.x, pt.y);
        }

        function endDraw() {
            if(!isDrawing) return;
            isDrawing = false;
            document.getElementById('ui-login').style.opacity = '1';

            if(rawPath.length < 20) {
                feedback("TOO SHORT", "red");
                return;
            }

            // --- THE MAGIC: NORMALIZE THE SHAPE ---
            const normalizedShape = normalizePath(rawPath);

            if (mode === 'RECORD') {
                saveSigil(normalizedShape);
            } else if (mode === 'VERIFY') {
                verifySigil(normalizedShape);
            }
        }

        // --- 2. MATH ENGINE (Normalization) ---
        // This makes the system "Fuzzy" and forgiving.
        
        function normalizePath(points) {
            // A. Resample to exactly 50 points (Fixes speed issues)
            const resampled = resample(points, 50);
            
            // B. Find Bounding Box
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            resampled.forEach(p => {
                if(p.x < minX) minX = p.x;
                if(p.x > maxX) maxX = p.x;
                if(p.y < minY) minY = p.y;
                if(p.y > maxY) maxY = p.y;
            });

            // C. Scale to 0.0 - 1.0 (Fixes size issues)
            const w = maxX - minX;
            const h = maxY - minY;
            const scale = Math.max(w, h) || 1;

            // D. Center (Fixes position issues)
            return resampled.map(p => ({
                x: (p.x - minX) / scale,
                y: (p.y - minY) / scale
            }));
        }

        function resample(points, n) {
            // Basic resampling to get N evenly spaced points
            // (Simplified for brevity, but effective for gestures)
            const stride = Math.ceil(points.length / n);
            const newPoints = [];
            for(let i=0; i<points.length; i+=stride) {
                newPoints.push(points[i]);
            }
            // Ensure exactly N
            while(newPoints.length > n) newPoints.pop();
            while(newPoints.length < n) newPoints.push(points[points.length-1]);
            return newPoints;
        }

        // --- 3. VERIFICATION ---

        function saveSigil(shape) {
            const callsign = sessionStorage.getItem('temp_callsign');
            const data = { callsign, shape };
            localStorage.setItem('abyss_sigil_v2', JSON.stringify(data));
            
            feedback("SIGIL FORGED", "#00ff41");
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function verifySigil(inputShape) {
            const stored = JSON.parse(localStorage.getItem('abyss_sigil_v2'));
            if(!stored) return;

            // Compare Distance (Euclidean matching of normalized points)
            let totalDist = 0;
            for(let i=0; i<inputShape.length; i++) {
                const p1 = inputShape[i];
                const p2 = stored.shape[i];
                const d = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
                totalDist += d;
            }
            
            const score = totalDist / inputShape.length; // Average error
            console.log("Difference Score:", score);

            // Threshold: < 0.25 is a good match for normalized shapes
            if(score < 0.25) {
                successLogin(stored.callsign);
            } else {
                feedback("MISMATCH", "red");
                if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
            }
        }

        function successLogin(callsign) {
            document.getElementById('lock-icon').classList.remove('text-gray-900');
            document.getElementById('lock-icon').classList.add('text-green-500');
            document.getElementById('status-text').innerText = "ACCESS GRANTED";
            
            // Generate Key from Callsign
            const key = "sk_ghost_" + CryptoJS.SHA256(callsign.toLowerCase() + "INFINITE_ABYSS_2025").toString().substring(0, 32);
            localStorage.setItem('chaos_key_vault', key);

            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1000);
        }

        // --- 4. UTILS & VISUALS ---

        function getPoint(e) {
            return {
                x: e.touches ? e.touches[0].clientX : e.clientX,
                y: e.touches ? e.touches[0].clientY : e.clientY
            };
        }

        function renderTrail(pt) {
            ctx.fillStyle = '#00ff41';
            ctx.beginPath();
            ctx.arc(pt.x, pt.y, 2, 0, Math.PI*2);
            ctx.fill();
        }

        function spawnParticle(x, y) {
            // Adds Chaos feel
            const p = document.createElement('div');
            p.classList.add('particle');
            const size = Math.random() * 4 + 2;
            p.style.width = size + 'px';
            p.style.height = size + 'px';
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1000);
        }

        function feedback(text, color) {
            const el = document.getElementById('status-text');
            el.innerText = text;
            el.style.color = color;
            el.classList.add('animate-pulse');
            setTimeout(() => {
                el.innerText = mode === 'RECORD' ? "DRAW SIGIL" : "DRAW SIGIL";
                el.style.color = "gray";
                el.classList.remove('animate-pulse');
                ctx.clearRect(0,0,canvas.width, canvas.height);
            }, 1000);
        }

        // --- INIT CHECK ---
        if(localStorage.getItem('abyss_sigil_v2')) {
            document.getElementById('ui-setup').classList.add('hidden');
            document.getElementById('ui-login').classList.remove('hidden');
            mode = 'VERIFY';
        }

        // EVENTS
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', moveDraw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', startDraw);
        canvas.addEventListener('touchmove', moveDraw);
        canvas.addEventListener('touchend', endDraw);
    </script>
</body>
</html>
