<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>A+ CHAOS | EAGLE EYE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@400;700&display=swap');
        body { background-color: #000; color: #00ff41; font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        
        .panel { 
            border: 1px solid #1a4d1a; 
            background: rgba(0, 15, 0, 0.95); 
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); 
            transition: all 0.3s ease;
        }
        
        .scroll-box { scrollbar-width: none; }
        .scroll-box::-webkit-scrollbar { display: none; }
        
        .blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Log Colors */
        .log-entry { border-bottom: 1px solid #112211; padding: 4px 0; font-size: 11px; }
        .log-BLOCK { color: #ff3333; border-left: 3px solid #ff3333; padding-left: 8px; }
        .log-AUTH { color: #00ff41; border-left: 3px solid #00ff41; padding-left: 8px; }
        .log-SYSTEM { color: #ffff33; border-left: 3px solid #ffff33; padding-left: 8px; }
        .log-FEEDBACK { color: #3388ff; border-left: 3px solid #3388ff; padding-left: 8px; background: rgba(0,20,50,0.3); }

        .stat-value { transition: color 0.5s; }
        .pulse-update { animation: text-flash 0.5s; }
        @keyframes text-flash { 0% { color: #fff; text-shadow: 0 0 10px #fff; } 100% { color: inherit; } }
    </style>
</head>
<body class="h-screen flex flex-col p-4 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">

    <!-- HEADER -->
    <div class="flex justify-between items-center mb-4 border-b border-green-900 pb-2 bg-black/80 p-3 rounded-lg backdrop-blur">
        <div class="flex items-center gap-3">
            <h1 class="text-2xl font-bold tracking-widest text-white"><i class="fas fa-eye text-green-500 mr-2"></i>EAGLE EYE</h1>
            <span class="text-[10px] text-gray-500 border border-gray-700 px-2 rounded">V125 LIVE</span>
        </div>
        <div class="flex gap-6 text-sm items-center">
            <div id="connection-status" class="text-green-500 font-bold flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full blink"></span> CONNECTED
            </div>
            <button onclick="location.href='/dashboard'" class="text-gray-400 hover:text-white border border-gray-700 px-3 py-1 rounded hover:bg-gray-800 transition">
                <i class="fas fa-sign-out-alt mr-1"></i> EXIT
            </button>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="flex-grow grid grid-cols-12 gap-4 h-full pb-4">
        
        <!-- LEFT: METRICS -->
        <div class="col-span-12 md:col-span-3 flex flex-col gap-4">
            <!-- TRAFFIC -->
            <div class="panel p-6 text-center rounded-lg">
                <div class="text-xs text-gray-400 mb-2 uppercase tracking-widest">Global Traffic</div>
                <div id="stat-reqs" class="text-5xl font-bold text-white stat-value">0</div>
                <div class="text-[10px] text-green-600 mt-1">REQUESTS / SEC</div>
            </div>
            
            <!-- THREATS -->
            <div class="panel p-6 text-center border-red-900/50 rounded-lg">
                <div class="text-xs text-red-500 mb-2 uppercase tracking-widest">Threats Neutralized</div>
                <div id="stat-threats" class="text-5xl font-bold text-red-500 stat-value">0</div>
                <div class="text-[10px] text-red-800 mt-1">NIGHTMARE FIREWALL</div>
            </div>

            <!-- INBOX COUNTER -->
            <div class="panel p-6 text-center border-blue-900/50 rounded-lg">
                <div class="text-xs text-blue-500 mb-2 uppercase tracking-widest">Comms Inbox</div>
                <div id="stat-inbox" class="text-5xl font-bold text-blue-400 stat-value">0</div>
                <div class="text-[10px] text-blue-800 mt-1">UNREAD SIGNALS</div>
            </div>
        </div>

        <!-- CENTER: LIVE LOGS -->
        <div class="col-span-12 md:col-span-6 flex flex-col gap-4">
            <div class="panel flex-grow flex flex-col relative overflow-hidden rounded-lg">
                <div class="flex justify-between items-center border-b border-green-900/50 p-3 bg-black/50">
                    <span class="text-xs text-gray-400 font-bold"><i class="fas fa-list-alt mr-2"></i> SYSTEM EVENT STREAM</span>
                    <span class="text-[10px] text-gray-600 font-mono">POLLING: 2s</span>
                </div>
                <div id="terminal" class="flex-grow overflow-y-auto font-mono text-xs p-4 scroll-box h-full flex flex-col gap-2">
                    <div class="text-gray-500 italic">> Establishing Secure Uplink to Abyss...</div>
                </div>
            </div>
        </div>

        <!-- RIGHT: FEEDBACK FEED -->
        <div class="col-span-12 md:col-span-3 flex flex-col gap-4">
            <div class="panel flex-grow flex flex-col relative overflow-hidden rounded-lg border-blue-900/30">
                <div class="flex justify-between items-center border-b border-blue-900/50 p-3 bg-black/50">
                    <span class="text-xs text-blue-400 font-bold"><i class="fas fa-envelope mr-2"></i> INCOMING COMMS</span>
                    <button onclick="sync()" class="text-[10px] hover:text-white text-blue-600"><i class="fas fa-sync"></i></button>
                </div>
                <div id="comms-feed" class="flex-grow overflow-y-auto font-mono text-xs space-y-3 p-3 scroll-box h-full">
                    <div class="text-gray-600 text-center mt-10">Waiting for signals...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        const token = sessionStorage.getItem('chaos_session');
        
        if (!token) {
            window.location.href = '/app.html';
        }

        // --- REAL TIME ENGINE ---
        let lastReqCount = 0;
        let lastThreatCount = 0;

        async function sync() {
            try {
                const headers = { 
                    'x-chaos-token': token,
                    'Content-Type': 'application/json' 
                };

                // 1. FETCH TELEMETRY
                const res = await fetch(`${API_BASE}/admin/telemetry`, { headers });
                
                if (res.status === 401) {
                    alert("Session Expired");
                    window.location.href = '/app.html';
                    return;
                }

                if (!res.ok) throw new Error("Server Sync Error");
                
                const data = await res.json();
                
                // Update Counters with Pulse Effect
                updateCounter('stat-reqs', data.stats.requests, lastReqCount);
                updateCounter('stat-threats', data.stats.threats, lastThreatCount);
                
                lastReqCount = data.stats.requests;
                lastThreatCount = data.stats.threats;

                // Update Central Terminal (Logs)
                const term = document.getElementById('terminal');
                if (data.logs && data.logs.length > 0) {
                    // Simple Diff: Check if top log matches
                    const topLog = term.firstElementChild?.innerText;
                    if (topLog !== data.logs[0]) {
                        term.innerHTML = ''; // Clear for fresh batch (simplest for now)
                        data.logs.forEach(log => {
                            const div = document.createElement('div');
                            // Style based on content
                            if (log.includes('BLOCK')) div.className = "log-entry log-BLOCK";
                            else if (log.includes('AUTH')) div.className = "log-entry log-AUTH";
                            else div.className = "log-entry log-SYSTEM";
                            div.innerText = log;
                            term.appendChild(div); // Append to bottom list? No, usually top is newest
                        });
                    }
                }

                // 2. FETCH FEEDBACK
                const feedRes = await fetch(`${API_BASE}/admin/feedback`, { headers });
                if (feedRes.ok) {
                    const feedData = await feedRes.json();
                    const messages = feedData.feedback || [];
                    
                    document.getElementById('stat-inbox').innerText = messages.length;
                    
                    const comms = document.getElementById('comms-feed');
                    if (messages.length > 0) {
                        comms.innerHTML = '';
                        messages.forEach(msg => {
                            const div = document.createElement('div');
                            div.className = "log-FEEDBACK p-2 rounded border-l-2 border-blue-500 bg-blue-900/10 mb-2";
                            div.innerHTML = `
                                <div class="flex justify-between mb-1">
                                    <strong class="text-blue-300">${msg.name}</strong>
                                    <span class="text-gray-500 text-[9px]">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                                </div>
                                <div class="text-gray-300 break-words">${msg.message}</div>
                            `;
                            comms.appendChild(div);
                        });
                    } else {
                        comms.innerHTML = '<div class="text-gray-600 text-center mt-20">No active comms.</div>';
                    }
                }

            } catch(e) { 
                console.error("Sync Error:", e);
                const status = document.getElementById('connection-status');
                status.className = "text-red-500 font-bold";
                status.innerText = "â— DISCONNECTED";
            }
        }

        function updateCounter(id, newVal, oldVal) {
            const el = document.getElementById(id);
            if (newVal !== oldVal) {
                el.innerText = newVal;
                el.classList.add('pulse-update');
                setTimeout(() => el.classList.remove('pulse-update'), 500);
            }
        }

        // Start Heartbeat
        setInterval(sync, 2000);
        sync();
    </script>
</body>
</html>
