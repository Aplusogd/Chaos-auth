<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A+ UNIVERSAL PORTAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .abyss-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%);
        }
        .abyss-stars {
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            opacity: 0.3; position: absolute; inset: 0; animation: drift 60s linear infinite;
        }

        .terminal-window {
            width: 100%; max-width: 600px; background: rgba(5,5,5,0.9);
            border: 1px solid #222; padding: 40px; 
            box-shadow: 0 0 80px rgba(0, 255, 65, 0.05);
            backdrop-filter: blur(10px); position: relative; overflow: hidden;
            transition: border-color 0.5s;
        }

        .input-line {
            background: transparent; border: none; border-bottom: 2px solid #333;
            color: white; font-size: 1.2rem; width: 100%; padding: 15px 0;
            outline: none; font-family: inherit; text-align: center; margin-top: 10px;
            letter-spacing: 1px; text-transform: capitalize;
        }
        .input-line:focus { border-bottom-color: #00ff41; }
        
        .btn-gen {
            margin-top: 25px; width: 100%; padding: 16px; background: #051a05;
            color: #00ff41; border: 1px solid #004400; font-weight: bold; cursor: pointer;
            transition: all 0.3s; text-transform: uppercase; letter-spacing: 3px; font-size: 0.8rem;
        }
        .btn-gen:hover { background: #00ff41; color: black; box-shadow: 0 0 30px rgba(0,255,65,0.3); border-color: #00ff41; }
        .btn-gen:disabled { opacity: 0.5; cursor: not-allowed; }

        .tab-btn { color: #444; cursor: pointer; padding: 5px 15px; border-bottom: 2px solid transparent; transition: all 0.3s; font-size: 0.75rem; letter-spacing: 2px; }
        .tab-btn.active { color: #00ff41; border-bottom-color: #00ff41; text-shadow: 0 0 10px rgba(0,255,65,0.3); }

        .word-pill {
            background: #000; border: 1px solid #333; padding: 10px 18px; color: #fff; 
            text-transform: capitalize; font-size: 1rem; letter-spacing: 1px; min-width: 100px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.9);
        }
        .word-pill:nth-child(1) { animation-delay: 0.1s; }
        .word-pill:nth-child(3) { animation-delay: 0.2s; }
        .word-pill:nth-child(5) { animation-delay: 0.3s; }

        .glyph-sep { color: #005500; font-size: 1rem; padding: 0 8px; opacity: 0.5; }

        @keyframes drift { from { background-position: 0 0; } to { background-position: 1000px 1000px; } }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="abyss-bg"><div class="abyss-stars"></div></div>

    <div class="terminal-window" id="main-ui">
        <div class="text-center mb-10">
            <div class="inline-block p-4 border border-green-900/30 rounded-full mb-4 bg-black/50">
                <i class="fas fa-dragon text-4xl text-green-700 animate-pulse"></i>
            </div>
            <h1 class="text-xl tracking-[0.4em] text-white font-bold uppercase">Infinite Abyss</h1>
            <div class="flex justify-center gap-10 mt-8 text-[10px] font-bold tracking-widest uppercase">
                <div class="tab-btn active" onclick="switchTab('new')" id="tab-new">Manifest</div>
                <div class="tab-btn" onclick="switchTab('recover')" id="tab-recover">Recall</div>
            </div>
        </div>

        <div id="view-new" class="text-center">
            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-8">Forge New Identity from Entropy</p>
            <button onclick="manifestIdentity()" id="btn-manifest" class="btn-gen relative overflow-hidden group">
                <span class="relative z-10"><i class="fas fa-meteor mr-2"></i> Unleash Chaos</span>
                <div class="absolute inset-0 bg-green-500/10 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-500"></div>
            </button>
            <div class="mt-6 flex justify-center gap-4 text-[9px] text-gray-700 font-mono">
                <span><i class="fas fa-shield-alt text-green-900 mr-1"></i> 256-BIT</span>
                <span><i class="fas fa-infinity text-green-900 mr-1"></i> SELF-HEALING</span>
            </div>
        </div>

        <div id="view-recover" class="hidden text-center">
            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-4">Speak Your True Name</p>
            <input type="text" id="recoveryInput" class="input-line" placeholder="Crimson-Velvet-Thunder" autocomplete="off" onkeyup="checkEnter(event)">
            <button onclick="recoverIdentity()" id="btn-recover" class="btn-gen mt-8">
                <i class="fas fa-dungeon mr-2"></i> Open Gate
            </button>
        </div>
        
        <div id="view-success" class="hidden text-center">
            <div class="text-green-500 text-xs mb-2 tracking-[0.2em] font-bold uppercase">Identity Forged</div>
            <div class="text-[10px] text-gray-500 mb-8">THIS IS YOUR CALLSIGN. DO NOT LOSE IT.</div>
            <div class="flex items-center justify-center flex-wrap gap-2 mb-10" id="word-display"></div>
            <button onclick="enterPortal()" class="btn-gen border-green-500 text-white hover:bg-white hover:text-black">
                <i class="fas fa-door-open mr-2"></i> Enter Tech Hub
            </button>
        </div>

        <div id="status-msg" class="text-center text-[10px] h-4 mt-8 text-red-500 font-bold tracking-widest uppercase"></div>
    </div>

    <script>
        // --- 1. CHAOS DICTIONARY ---
        const CHAOS_DIMENSIONS = {
            color:    ["Crimson","Void","Obsidian","Plasma","Neon","Ultraviolet","Ash","Onyx","Blood","Midnight","Venom","Rust","Vanta","Eclipse","Inferno","Magma","Nova","Aurora","Quantum","Singularity"],
            texture:  ["Velvet","Razor","Leather","Mercury","Shatter","Silk","Iron","Glass","Carbon","Diamond","Chain","Thorn","Blade","Fang","Talon","Needle","Frost","Static","Pulse","Skin"],
            force:    ["Thunder","Abyss","Vortex","Ragnarok","Storm","Eclipse","Nova","Wrath","Entropy","Chaos","Doom","Oblivion","Revenge","Nemesis","Collapse","Detonation","Leviathan","Reaper","Gravity","Resonance"],
            animal:   ["Raven","Serpent","Wolf","Kraken","Phoenix","Dragon","Hydra","Wraith","Panther","Scorpion","Viper","Shark","Spider","Manticore","Chimera","Basilisk","Jackal","Crow","Owl","Bat"],
            weapon:   ["Dagger","Scythe","Katana","Chains","Whip","Gauntlet","Claw","Fang","Spear","Halberd","Flail","Morningstar","Trident","Kris","Kukri","Tanto","Shiv","Stiletto","Garrote","Noose"]
        };
        const GLYPHS = ["†", "‡", "⚡", "⚶", "⚔", "☠", "⚛", "☣", "☾", "✖"];
        const DIMENSION_KEYS = Object.keys(CHAOS_DIMENSIONS);

        // --- 2. ENTROPY ORACLE ---
        function chaosOracle(seed) {
            const sources = [seed, navigator.userAgent, screen.width, new Date().getTimezoneOffset(), performance.now()].join("|");
            return CryptoJS.SHA512(sources).toString();
        }

        // --- 3. WORD LOGIC ---
        function getChaosWord(dimension, hash, offset) {
            const words = CHAOS_DIMENSIONS[dimension];
            const chunk = hash.substr(offset * 5, 5); 
            const rand = parseInt(chunk, 16) / 0xFFFFF; 
            const index = Math.floor(rand * words.length);
            return words[index];
        }

        // --- 4. MANIFEST IDENTITY ---
        async function manifestIdentity() {
            setLoading('btn-manifest', true);
            
            // A. Generate Math
            const entropy = chaosOracle(Date.now().toString());
            const d1 = parseInt(entropy.substr(0, 2), 16) % DIMENSION_KEYS.length;
            const d2 = parseInt(entropy.substr(2, 2), 16) % DIMENSION_KEYS.length;
            const d3 = parseInt(entropy.substr(4, 2), 16) % DIMENSION_KEYS.length;

            const w1 = getChaosWord(DIMENSION_KEYS[d1], entropy, 1);
            const w2 = getChaosWord(DIMENSION_KEYS[d2], entropy, 2);
            const w3 = getChaosWord(DIMENSION_KEYS[d3], entropy, 3);
            
            const phrase = `${w1}-${w2}-${w3}`;
            const key = phraseToKey(phrase);

            // B. SYNC WITH SERVER (CRITICAL STEP)
            const success = await registerWithServer(key, "GHOST-" + phrase.substring(0,5));

            setLoading('btn-manifest', false);

            if (success) {
                const sep = GLYPHS[parseInt(entropy.substr(6, 1), 16) % GLYPHS.length];
                const display = document.getElementById('word-display');
                display.innerHTML = `
                    <div class="word-pill border-b-2 border-red-900">${w1}</div>
                    <span class="glyph-sep">${sep}</span>
                    <div class="word-pill border-b-2 border-green-900">${w2}</div>
                    <span class="glyph-sep">${sep}</span>
                    <div class="word-pill border-b-2 border-blue-900">${w3}</div>
                `;
                localStorage.setItem('chaos_key_vault', key);
                document.getElementById('view-new').classList.add('hidden');
                document.getElementById('view-success').classList.remove('hidden');
            } else {
                document.getElementById('status-msg').innerText = "SERVER CONNECTION FAILED";
            }
        }

        // --- 5. RECOVERY LOGIC (Self-Healing) ---
        function phraseToKey(phrase) {
            return "sk_ghost_" + CryptoJS.SHA256(phrase.toLowerCase() + "INFINITE_ABYSS_2025").toString().substring(0,32);
        }

        async function recoverIdentity() {
            const input = document.getElementById('recoveryInput').value.trim();
            const msg = document.getElementById('status-msg');

            if (input.startsWith('sk_chaos')) {
                finalizeLogin(input);
                return;
            }

            if (!input.includes('-') && !input.includes(' ')) {
                msg.innerText = "INVALID FORMAT. USE: WORD-WORD-WORD";
                return;
            }

            setLoading('btn-recover', true);
            const cleanPhrase = input.replace(/\s+/g, '-');
            const key = phraseToKey(cleanPhrase);

            // C. AUTO-HEAL: Tell server "I exist" even if it forgot
            const success = await registerWithServer(key, "GHOST-" + cleanPhrase.substring(0,5));
            setLoading('btn-recover', false);

            if (success) {
                finalizeLogin(key);
            } else {
                msg.innerText = "CONNECTION FAILED. RETRY.";
            }
        }

        // --- 6. SERVER SYNC (The Fix) ---
        async function registerWithServer(key, alias) {
            try {
                const res = await fetch('/api/auth/ghost-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        alias: alias, 
                        chaos_metric: Math.random(),
                        provided_key: key // WE TELL SERVER THE KEY NOW
                    })
                });
                const data = await res.json();
                return data.success;
            } catch (e) {
                console.error(e);
                return false;
            }
        }

        function finalizeLogin(key) {
            localStorage.setItem('chaos_key_vault', key);
            if(key.includes('chaos')) window.location.href = '/dashboard';
            else window.location.href = '/check.html';
        }

        function enterPortal() {
            window.location.href = '/check.html';
        }

        function checkEnter(e) { if(e.key === 'Enter') recoverIdentity(); }

        function switchTab(tab) {
            document.getElementById('status-msg').innerText = "";
            if (tab === 'new') {
                document.getElementById('view-new').classList.remove('hidden');
                document.getElementById('view-recover').classList.add('hidden');
                document.getElementById('tab-new').classList.add('active');
                document.getElementById('tab-recover').classList.remove('active');
            } else {
                document.getElementById('view-new').classList.add('hidden');
                document.getElementById('view-recover').classList.remove('hidden');
                document.getElementById('tab-new').classList.remove('active');
                document.getElementById('tab-recover').classList.add('active');
            }
        }

        function setLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> SYNCING...';
            } else {
                btn.disabled = false;
                if(btnId === 'btn-manifest') btn.innerHTML = '<i class="fas fa-meteor mr-2"></i> Unleash Chaos';
                else btn.innerHTML = '<i class="fas fa-dungeon mr-2"></i> Open Gate';
            }
        }

        // AUTO-LOGIN
        window.onload = () => {
            const savedKey = localStorage.getItem('chaos_key_vault');
            if(savedKey) {
                document.getElementById('main-ui').style.borderColor = "#00ff41";
            }
        };
    </script>
</body>
</html>
