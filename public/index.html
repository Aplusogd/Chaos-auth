<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A+ UNIVERSAL PORTAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background: #000; height: 100vh; overflow: hidden; color: white; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* ANIMATED BACKGROUND */
        .portal-bg {
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(0, 255, 65, 0.05) 0%, transparent 50%),
                linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)),
                url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2940&auto=format&fit=crop');
            background-size: cover; background-position: center;
        }

        .card { background: rgba(10,10,10,0.8); border: 1px solid #333; backdrop-filter: blur(10px); transition: all 0.3s; }
        .card:hover { border-color: #00ff41; box-shadow: 0 0 20px rgba(0,255,65,0.1); }
        
        .input-field {
            background: #111; border: 1px solid #333; color: white; padding: 12px; width: 100%;
            border-radius: 6px; outline: none; transition: all 0.2s; font-size: 0.9rem; text-align: center;
        }
        .input-field:focus { border-color: #00ff41; }
        
        .btn-action {
            background: #004400; color: #00ff41; border: 1px solid #00ff41; width: 100%; padding: 12px;
            border-radius: 6px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s; cursor: pointer;
        }
        .btn-action:hover { background: #00ff41; color: black; }

        /* LOADING SPINNER */
        .scanner { height: 2px; width: 100%; background: #00ff41; position: absolute; top: 0; left: 0; animation: scan 2s infinite; opacity: 0; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    </style>
</head>
<body class="portal-bg flex items-center justify-center relative">

    <div id="bio-scan" class="absolute inset-0 bg-black z-50 flex flex-col items-center justify-center hidden">
        <div class="text-green-500 text-4xl mb-4"><i class="fas fa-fingerprint fa-pulse"></i></div>
        <div class="text-green-500 font-mono tracking-widest text-sm">BIOMETRIC HANDSHAKE...</div>
        <div class="text-gray-600 text-xs mt-2">Verifying Device Integrity</div>
    </div>

    <div class="max-w-4xl w-full grid md:grid-cols-2 gap-8 p-8" id="main-interface">
        
        <div class="flex flex-col justify-center">
            <h1 class="text-5xl font-extrabold tracking-tighter mb-4">A+ <span class="text-green-500">PORTAL</span></h1>
            <p class="text-gray-400 mb-8 max-w-sm leading-relaxed">
                Secure gateway for A+ Overhead Garage Doors. Access requires device registration and Chaos Core verification.
            </p>
            
            <div class="flex items-center gap-4 text-xs font-mono text-gray-500">
                <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> SYSTEM ONLINE</div>
                <div>v182.4 CORE</div>
            </div>
        </div>

        <div class="space-y-4">

            <div class="card p-6 rounded-xl relative overflow-hidden group">
                <div class="scanner group-hover:opacity-50"></div>
                <h2 class="text-xl font-bold mb-1"><i class="fas fa-user-plus mr-2 text-green-500"></i> New Identity</h2>
                <p class="text-xs text-gray-500 mb-4">Create a guest profile. Includes bot check.</p>
                
                <div id="guest-form">
                    <input type="text" id="guestName" class="input-field mb-3" placeholder="Enter Your Name">
                    <button onclick="registerGuest()" class="btn-action">
                        INITIALIZE & VERIFY
                    </button>
                </div>
            </div>

            <div class="card p-6 rounded-xl">
                <h2 class="text-xl font-bold mb-1"><i class="fas fa-key mr-2 text-blue-500"></i> Enter Access Code</h2>
                <p class="text-xs text-gray-500 mb-4">For Staff & Admins with an existing key.</p>
                
                <div id="tech-form">
                    <input type="password" id="accessCode" class="input-field mb-3 font-mono" placeholder="sk_...">
                    <button onclick="registerDevice()" class="btn-action" style="border-color: #3b82f6; color: #3b82f6;">
                        REGISTER DEVICE
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. DEVICE CHECK ON LOAD ---
        window.onload = async function() {
            const savedKey = localStorage.getItem('chaos_key_vault');
            
            if (savedKey) {
                // If key exists, verify it silently
                document.getElementById('main-interface').classList.add('opacity-0');
                document.getElementById('bio-scan').classList.remove('hidden');
                
                const isValid = await verifyKey(savedKey);
                
                if (isValid) {
                    setTimeout(() => {
                        window.location.href = '/dashboard'; // Or appropriate landing based on role
                    }, 1500);
                } else {
                    // Key was revoked or invalid
                    localStorage.removeItem('chaos_key_vault');
                    document.getElementById('bio-scan').classList.add('hidden');
                    document.getElementById('main-interface').classList.remove('opacity-0');
                    alert("DEVICE AUTHORIZATION EXPIRED. Please register again.");
                }
            }
        };

        // --- 2. GUEST REGISTRATION (SELF-MINT) ---
        async function registerGuest() {
            const name = document.getElementById('guestName').value.trim();
            if (!name) return alert("Name required.");

            // A. Client-Side Chaos Check (Simple Entropy)
            const entropy = Math.random(); 

            // B. Call Server to Register
            try {
                // Note: Ensure your server has the /api/auth/guest-register route I provided!
                // If not, we fall back to a simulation for the demo UI.
                
                // SIMULATION for UI DEMO (Replace with fetch in production)
                // const res = await fetch('/api/auth/guest-register', ...);
                
                // MOCK RESPONSE FOR NOW (So you can see the UI flow)
                console.log("Simulating Registration...");
                await new Promise(r => setTimeout(r, 1000));
                
                // In production, this comes from the server
                const mockKey = "sk_test_" + Math.random().toString(36).substring(7); 
                
                localStorage.setItem('chaos_key_vault', mockKey);
                alert(`IDENTITY VERIFIED.\n\nYour Temporary Access Key:\n${mockKey}\n\nDevice Registered.`);
                window.location.href = '/check.html'; // Send guests to the Check Portal
                
            } catch (e) {
                alert("Registration Failed.");
            }
        }

        // --- 3. TECH REGISTRATION (EXISTING KEY) ---
        async function registerDevice() {
            const key = document.getElementById('accessCode').value.trim();
            if (!key) return alert("Enter Access Code.");

            const isValid = await verifyKey(key);
            if (isValid) {
                localStorage.setItem('chaos_key_vault', key);
                // Save session for immediate use
                sessionStorage.setItem('chaos_session', key);
                
                alert("DEVICE REGISTERED SUCCESSFULLY.\nAccess granted until revocation.");
                
                // Redirect based on key type (Logic can be improved with server response)
                if(key.includes('chaos')) window.location.href = '/dashboard'; // Admin
                else window.location.href = '/dashboard'; // Techs also go to dash (restricted view)
            } else {
                alert("INVALID ACCESS CODE.");
            }
        }

        // --- SHARED: VERIFY KEY ---
        async function verifyKey(token) {
            try {
                // Use the God Lock endpoint to check validity
                const res = await fetch('/api/admin/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                const data = await res.json();
                return data.valid;
            } catch (e) {
                console.error("Auth Error", e);
                return false;
            }
        }
    </script>
</body>
</html>
