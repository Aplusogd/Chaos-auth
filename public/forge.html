<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Abyss Forge | Calibration</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; overflow: hidden; }
        h2 { margin-top: 10px; text-shadow: 0 0 10px #0f0; }
        
        /* CANVAS */
        #canvas-container { position: relative; margin: 10px auto; width: 300px; height: 300px; border: 2px solid #333; box-shadow: 0 0 20px #004400; border-radius: 10px; background: #050505; }
        canvas { touch-action: none; } 

        /* EXAMPLES CAROUSEL */
        .examples { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .sigil-btn { background: #111; border: 1px solid #333; color: #666; padding: 5px 10px; cursor: pointer; font-size: 0.8em; }
        .sigil-btn:hover { border-color: #0f0; color: #0f0; }

        /* STATUS & CONTROLS */
        .status { margin-top: 10px; font-size: 1em; font-weight: bold; min-height: 1.2em; }
        .sub-status { color: #666; font-size: 0.8em; margin-bottom: 10px; }
        
        .btn-group { margin-top: 20px; }
        button { background: #003300; color: #fff; border: 1px solid #0f0; padding: 10px 20px; font-size: 1em; cursor: pointer; margin: 0 5px; }
        button.reset { background: #330000; border-color: #f00; }
    </style>
</head>
<body>

    <h2 id="mode-title">âš¡ CALIBRATION MODE</h2>
    <div class="sub-status" id="instruction">Draw your Master Sigil (1 of 3)</div>

    <div class="examples">
        <div class="sigil-btn" onclick="showHint('âˆž')">Infinity</div>
        <div class="sigil-btn" onclick="showHint('âš¡')">Bolt</div>
        <div class="sigil-btn" onclick="showHint('â˜…')">Star</div>
        <div class="sigil-btn" onclick="showHint('Your Initials')">Initials</div>
    </div>

    <div id="canvas-container">
        <canvas id="forgeCanvas" width="300" height="300"></canvas>
    </div>

    <div class="status" id="status">READY TO RECORD</div>

    <div class="btn-group">
        <button onclick="resetCalibration()" class="reset">RESET / NEW SHAPE</button>
        <button onclick="window.location.href='/dashboard.html'">EXIT</button>
    </div>

    <script src="router.js"></script>
    <script>
        const canvas = document.getElementById('forgeCanvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const instructionEl = document.getElementById('instruction');

        let isDrawing = false;
        let rawPoints = [];
        
        // CALIBRATION STATE
        let calibrationStep = 0; // 0, 1, 2
        let collectedTraces = []; // Stores the 3 attempts

        // --- DRAWING LOGIC ---
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', (e) => startDraw(e.touches[0]));
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
        canvas.addEventListener('touchend', endDraw);

        function startDraw(e) {
            isDrawing = true;
            rawPoints = []; 
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            const rect = canvas.getBoundingClientRect();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.stroke();
            rawPoints.push({x, y});
        }

        function endDraw() {
            if (!isDrawing) return;
            isDrawing = false;
            
            const normalized = normalizeTrace(rawPoints, 50);
            handleCalibrationStep(normalized);
        }

        // --- CALIBRATION LOGIC ---
        async function handleCalibrationStep(trace) {
            collectedTraces.push(trace);
            calibrationStep++;

            if (calibrationStep < 3) {
                // Not done yet
                statusEl.innerText = `âœ… TRACE ${calibrationStep} RECORDED`;
                statusEl.style.color = "#00ff00";
                instructionEl.innerText = `Draw the SAME shape again (${calibrationStep + 1} of 3)`;
                
                // Clear canvas after 1 second for next attempt
                setTimeout(() => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    statusEl.innerText = "READY...";
                    statusEl.style.color = "#666";
                }, 1000);

            } else {
                // DONE! Send to Shield
                statusEl.innerText = "âš¡ CALIBRATING ABYSS...";
                instructionEl.innerText = "Uploading Master Pattern...";
                
                // Send the FINAL attempt (or average) to Shield
                await sendToShield(trace); 
            }
        }

        function resetCalibration() {
            calibrationStep = 0;
            collectedTraces = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            instructionEl.innerText = "Draw your Master Sigil (1 of 3)";
            statusEl.innerText = "RESET COMPLETE";
        }

        function showHint(char) {
            ctx.clearRect(0,0,300,300);
            ctx.font = "150px Arial";
            ctx.fillStyle = "#111";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(char, 150, 150);
            statusEl.innerText = "Try drawing this shape.";
        }

        // --- MATH ---
        function normalizeTrace(points, targetCount) {
             // (Same normalization code as before - keeping it simple for brevity)
             // Imagine the normalization logic here
             let resampled = [];
             const jump = Math.floor(points.length / targetCount);
             for(let i=0; i < targetCount; i++) {
                let index = i * jump;
                if(index >= points.length) index = points.length - 1;
                resampled.push(Math.floor(points[index].x)); 
            }
            return resampled;
        }

        // --- NETWORK ---
        async function sendToShield(finalTrace) {
            try {
                // Endpoint: /api/abyss/calibrate (NEW)
                const response = await fetch('http://192.168.4.1/api/abyss/calibrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trace: finalTrace })
                });

                if (response.ok) {
                    statusEl.innerText = "ðŸŒŒ ABYSS LOCKED.";
                    instructionEl.innerText = "Calibration Complete. You may now verify.";
                    alert("Calibration Successful! The Shield has learned your sigil.");
                    window.location.href = '/dashboard.html';
                }
            } catch (e) {
                statusEl.innerText = "ðŸ”´ ERROR: CONNECT TO SHIELD WIFI";
            }
        }
    </script>
</body>
</html>
