<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A+ SANCTUARY | HOME BASE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* BASE THEME */
        html, body { background-color: #000000; color: #e5e5e5; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* ANIMATED BACKGROUND */
        .sanctuary-bg {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0a1a0a 0%, #000 100%);
        }
        .grid-lines {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 60%, transparent 100%);
        }

        /* WIDGET STYLING */
        .widget {
            background: rgba(15, 15, 15, 0.8); border: 1px solid #222; 
            backdrop-filter: blur(10px); border-radius: 8px; padding: 1.2rem;
            transition: transform 0.2s, border-color 0.2s; display: flex; flex-col: column;
        }
        .widget:hover { border-color: #333; }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .widget-title { font-size: 0.75rem; font-weight: bold; color: #666; text-transform: uppercase; letter-spacing: 1px; }

        /* TOGGLE SWITCHES */
        .toggle-checkbox:checked { right: 0; border-color: #00ff41; }
        .toggle-checkbox:checked + .toggle-label { background-color: #00ff41; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
        
        .switch {
            position: relative; display: inline-block; width: 34px; height: 18px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #00ff41; }
        input:checked + .slider:before { transform: translateX(16px); background-color: black; }

        /* BLACK BOX REDACTION */
        .redacted { background: #000; color: #000; user-select: none; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="sanctuary-bg"></div>
    <div class="grid-lines"></div>

    <div id="loader" class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center">
        <i class="fas fa-fingerprint fa-spin text-4xl text-green-600 mb-4"></i>
        <div class="text-xs tracking-widest text-green-500 font-mono">DECRYPTING SANCTUARY...</div>
    </div>

    <div id="dashboard" class="max-w-7xl mx-auto hidden opacity-0 transition-opacity duration-1000">
        
        <header class="flex flex-col md:flex-row justify-between items-end mb-8 pb-6 border-b border-gray-900 gap-4">
            <div>
                <div class="text-[10px] text-green-500 font-mono mb-2 uppercase tracking-widest">
                    <i class="fas fa-satellite-dish mr-1"></i> Uplink Established • San Antonio, TX
                </div>
                <h1 class="text-3xl font-bold text-white mb-2" id="greeting-text">Welcome back.</h1>
                <div class="flex gap-4 text-xs text-gray-400 font-mono">
                    <span><i class="fas fa-clock mr-1"></i> <span id="clock">00:00</span></span>
                    <span><i class="fas fa-cloud mr-1"></i> <span id="weather">85°F Clear</span></span>
                    <span><i class="fas fa-calendar-check mr-1"></i> 3 Active Tasks</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-[10px] text-gray-600 uppercase">Current Rank</div>
                    <div id="rank-badge" class="text-sm font-bold text-green-500 border border-green-900 bg-green-900/10 px-3 py-1 rounded">NEWBORN</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-600 uppercase">Trust Score</div>
                    <div id="trust-score" class="text-2xl font-bold text-white font-mono">0%</div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="widget md:col-span-2 border-l-4 border-l-red-600">
                <div class="widget-header">
                    <span class="widget-title text-red-500"><i class="fas fa-box-open mr-2"></i> THE BLACK BOX</span>
                    <button id="lock-btn" onclick="toggleLock()" class="text-xs text-gray-500 hover:text-white transition">
                        <i class="fas fa-lock"></i> LOCKED
                    </button>
                </div>
                <div class="relative flex-grow">
                    <textarea id="secret-notes" class="w-full h-32 bg-black border border-gray-800 rounded p-3 text-sm text-green-500 font-mono focus:border-green-500 focus:outline-none resize-none redacted" placeholder="Decryption required..." readonly></textarea>
                    <div id="lock-overlay" class="absolute inset-0 bg-black/90 flex items-center justify-center text-red-500 font-mono text-xs tracking-widest">
                        [ ENCRYPTED CONTENT ]
                    </div>
                </div>
                <div class="mt-2 flex justify-between items-center">
                    <span class="text-[10px] text-gray-600">AES-256 ENCRYPTION ACTIVE</span>
                    <button onclick="saveNotes()" class="text-xs bg-red-900/20 text-red-500 px-3 py-1 rounded hover:bg-red-500 hover:text-black transition">
                        SAVE TO VOID
                    </button>
                </div>
            </div>

            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title text-blue-500"><i class="fas fa-link mr-2"></i> CHAOS ATTACHED</span>
                    <div class="h-2 w-2 bg-blue-500 rounded-full animate-pulse"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center bg-black/40 p-2 rounded">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-mobile-alt text-gray-400"></i>
                            <div class="text-xs text-gray-300">This Device</div>
                        </div>
                        <span class="text-[10px] text-green-500 font-mono">ACTIVE</span>
                    </div>
                    <div class="flex justify-between items-center bg-black/40 p-2 rounded opacity-60">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-warehouse text-gray-400"></i>
                            <div class="text-xs text-gray-300">Garage Hub</div>
                        </div>
                        <span class="text-[10px] text-yellow-500 font-mono">STANDBY</span>
                    </div>
                    <div class="flex justify-between items-center bg-black/40 p-2 rounded opacity-60">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-desktop text-gray-400"></i>
                            <div class="text-xs text-gray-300">Tech Portal</div>
                        </div>
                        <span class="text-[10px] text-blue-500 font-mono">LINKED</span>
                    </div>
                </div>
            </div>

            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title text-green-500"><i class="fas fa-toggle-on mr-2"></i> REMOTE OPS</span>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-300">Open Shop Bay</span>
                        <label class="switch">
                            <input type="checkbox" onchange="toggleOp('Shop Bay')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-300">Arm Security</span>
                        <label class="switch">
                            <input type="checkbox" onchange="toggleOp('Security')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-300">Track Fleet</span>
                        <label class="switch">
                            <input type="checkbox" onchange="toggleOp('Fleet Tracker')">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title text-yellow-500"><i class="fas fa-chart-line mr-2"></i> METRICS</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-black/40 p-2 rounded text-center">
                        <div class="text-[10px] text-gray-500">PENDING</div>
                        <div class="text-sm font-bold text-white">$4,250</div>
                    </div>
                    <div class="bg-black/40 p-2 rounded text-center">
                        <div class="text-[10px] text-gray-500">INSTALLS</div>
                        <div class="text-sm font-bold text-green-400">12</div>
                    </div>
                    <div class="bg-black/40 p-2 rounded text-center col-span-2">
                        <div class="text-[10px] text-gray-500">NEXT APPT</div>
                        <div class="text-xs font-bold text-white">14:30 @ OAK ST</div>
                    </div>
                </div>
            </div>

            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title text-purple-500"><i class="fas fa-key mr-2"></i> IDENTITY</span>
                    <button onclick="copyKey()" class="text-xs text-gray-500 hover:text-white"><i class="fas fa-copy"></i></button>
                </div>
                <div class="bg-black p-3 rounded border border-gray-800 text-[10px] font-mono text-gray-500 break-all cursor-pointer hover:text-white transition" onclick="revealKey()" id="api-key-display">
                    •••••••••••••••••••••
                </div>
                <div class="mt-auto pt-4">
                    <a href="/sdk" class="block w-full text-center text-[10px] bg-gray-800 hover:bg-gray-700 py-2 rounded text-gray-300 transition">
                        VIEW INTEGRATION DOCS
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CORE VARIABLES ---
        let currentKey = localStorage.getItem('chaos_key_vault');
        let isLocked = true;

        // --- 1. INITIALIZE ---
        window.onload = async () => {
            if (!currentKey) {
                window.location.href = '/'; 
                return;
            }

            // A. Update Clock & Weather
            updateTime();
            setInterval(updateTime, 60000);

            // B. Fetch Profile from Server
            try {
                const res = await fetch('/api/v1/sentinel/verify', {
                    method: 'POST',
                    headers: { 'x-api-key': currentKey }
                });
                
                if (res.status === 200) {
                    const data = await res.json();
                    renderDashboard(data);
                } else {
                    // Offline/Error Fallback
                    renderDashboard({ project: "GHOST_MODE", rank: "OFFLINE", trustScore: 0 });
                }
            } catch (e) {
                renderDashboard({ project: "OFFLINE", rank: "LOCAL", trustScore: 0 });
            }
        };

        function renderDashboard(data) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            setTimeout(() => document.getElementById('dashboard').classList.remove('opacity-0'), 100);

            // Greeting
            const callsign = data.project || "Traveler";
            document.getElementById('greeting-text').innerText = `Welcome back, ${callsign.split('-')[0]}.`;
            
            // Stats
            document.getElementById('rank-badge').innerText = data.rank;
            document.getElementById('trust-score').innerText = data.trustScore + "%";
            document.getElementById('api-key-display').innerText = currentKey.substring(0, 16) + "••••••••";

            // Load Saved Notes (Encrypted)
            if(localStorage.getItem('black_box_notes')) {
                document.getElementById('secret-notes').value = localStorage.getItem('black_box_notes');
            }
        }

        // --- 2. THE BLACK BOX (Secure Notes) ---
        async function toggleLock() {
            const area = document.getElementById('secret-notes');
            const overlay = document.getElementById('lock-overlay');
            const btn = document.getElementById('lock-btn');

            if (isLocked) {
                // UNLOCKING
                const saved = localStorage.getItem('black_box_notes');
                if (saved) {
                    try {
                        const decrypted = await decryptData(saved, currentKey);
                        area.value = decrypted;
                    } catch(e) {
                        area.value = "Decryption Failed.";
                    }
                } else {
                    area.value = "";
                }
                
                area.readOnly = false;
                area.classList.remove('redacted');
                overlay.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-unlock"></i> UNLOCKED';
                btn.classList.replace('text-gray-500', 'text-green-500');
                isLocked = false;
            } else {
                // LOCKING
                area.readOnly = true;
                area.classList.add('redacted');
                overlay.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-lock"></i> LOCKED';
                btn.classList.replace('text-green-500', 'text-gray-500');
                isLocked = true;
            }
        }

        async function saveNotes() {
            if (isLocked) return alert("Unlock first.");
            
            const text = document.getElementById('secret-notes').value;
            const encrypted = await encryptData(text, currentKey);
            localStorage.setItem('black_box_notes', encrypted);
            
            // Visual Feedback
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "SAVED";
            btn.classList.add('text-green-500');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('text-green-500');
                toggleLock(); // Auto-lock on save
            }, 1000);
        }

        // --- 3. CRYPTO ENGINE (Local AES) ---
        // Uses the API Key itself as the encryption seed
        async function encryptData(data, keyString) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(keyString.substring(0,32)), "AES-GCM", false, ["encrypt"]);
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, keyMaterial, enc.encode(data));
            
            // Bundle IV + Data
            const ivArr = Array.from(iv);
            const encArr = Array.from(new Uint8Array(encrypted));
            return JSON.stringify({ iv: ivArr, data: encArr });
        }

        async function decryptData(jsonStr, keyString) {
            try {
                const bundle = JSON.parse(jsonStr);
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(keyString.substring(0,32)), "AES-GCM", false, ["decrypt"]);
                
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(bundle.iv) }, 
                    keyMaterial, 
                    new Uint8Array(bundle.data)
                );
                
                return new TextDecoder().decode(decrypted);
            } catch(e) { return "ERROR"; }
        }

        // --- 4. UTILS ---
        function updateTime() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function toggleOp(name) {
            if(navigator.vibrate) navigator.vibrate(50);
            console.log(`Toggled: ${name}`);
            // In a real app, fetch('/api/iot/toggle', ...)
        }

        function revealKey() {
            const el = document.getElementById('api-key-display');
            if(el.innerText.includes('•')) el.innerText = currentKey;
            else el.innerText = currentKey.substring(0, 16) + "••••••••";
        }

        function copyKey() {
            navigator.clipboard.writeText(currentKey);
            alert("Key Copied");
        }
    </script>
</body>
</html>
