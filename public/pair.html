<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chaos Pair</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="router.js"></script>
</head>
<body class="bg-black text-green-500 flex flex-col items-center justify-center min-h-screen font-mono p-4">
    <div class="border border-green-900 bg-gray-900 bg-opacity-50 p-6 rounded-lg max-w-sm w-full text-center">
        <h1 class="text-xl font-bold mb-2">BIND DEVICE</h1>
        <p class="text-xs text-gray-400 mb-6">Draw sigil to sign the challenge.</p>

        <div class="bg-black border border-green-800 p-3 mb-4 rounded">
            <span class="text-xs text-gray-500 block">CHALLENGE:</span>
            <span id="challenge" class="text-lg font-bold tracking-widest text-white">LOADING...</span>
        </div>

        <canvas id="canvas" width="280" height="200" class="border border-green-700 bg-black mx-auto mb-4 cursor-crosshair touch-none"></canvas>

        <div id="qr" class="hidden bg-white p-2 mx-auto mb-4 w-[200px] h-[200px]"></div>
        <p id="status" class="text-xs">Waiting for signature...</p>
    </div>

    <script>
        // 1. Generate Fake Challenge (In real life, get this from the Plug)
        const words = ["VOID","ASH","SKY","RED"];
        const challengeText = words.sort(()=>0.5-Math.random()).slice(0,3).join('-');
        document.getElementById('challenge').textContent = challengeText;

        // 2. Drawing Logic
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let points = 0;
        
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            const r = canvas.getBoundingClientRect();
            ctx.fillStyle = '#00ff41';
            ctx.fillRect(t.clientX - r.left, t.clientY - r.top, 3, 3);
            points++;
        });

        canvas.addEventListener('touchend', () => {
            if(points > 50) {
                // 3. Generate QR Code on Success
                const signature = CryptoJS.SHA256(challengeText + localStorage.getItem('callsign_history')).toString().substring(0,16);
                const qrData = `CHAOS-BIND:${signature}`;
                
                document.getElementById('canvas').classList.add('hidden');
                document.getElementById('qr').classList.remove('hidden');
                document.getElementById('qr').innerHTML = ""; 
                
                new QRCode(document.getElementById('qr'), {
                    text: qrData,
                    width: 180,
                    height: 180
                });
                document.getElementById('status').textContent = "SCAN THIS WITH PLUG CAMERA";
                document.getElementById('status').classList.add('text-white', 'font-bold');
            }
        });
    </script>
</body>
</html>
